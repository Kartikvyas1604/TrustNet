// This is your Prisma schema file for TrustNet with NeonDB
// Organization: org-sweet-thunder-69253070
// Project: still-wave-19438729

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION MODEL
// ============================================================================

model Organization {
  id                 String   @id @default(cuid())
  organizationId     String   @unique @map("organization_id")
  name               String
  legalBusinessName  String   @map("legal_business_name")
  registrationNumber String   @map("registration_number")
  country            String
  businessAddress    Json     @map("business_address") // {street, city, state, zip}
  industry           String?
  websiteUrl         String?  @map("website_url")
  
  // Admin Contact Info
  adminName          String   @map("admin_name")
  adminEmail         String   @map("admin_email")
  adminPhone         String   @map("admin_phone")
  adminJobTitle      String   @map("admin_job_title")
  
  // KYC & Verification
  kycStatus          KYCStatus @default(PENDING) @map("kyc_status")
  kycDocuments       Json?    @map("kyc_documents") // {businessCert: url, proofOfAddress: url, adminId: url, taxDoc: url}
  verifiedAt         DateTime? @map("verified_at")
  verificationNotes  String?  @map("verification_notes")
  
  // Subscription & Payment
  subscriptionTier   SubscriptionTier @default(STARTER) @map("subscription_tier")
  employeeLimit      Int      @default(10) @map("employee_limit")
  subscriptionStatus SubscriptionStatus @default(TRIAL) @map("subscription_status")
  paymentStatus      PaymentStatus @default(PENDING) @map("payment_status")
  monthlyPrice       String?  @map("monthly_price")
  annualPrice        String?  @map("annual_price")
  billingCycle       BillingCycle @default(MONTHLY) @map("billing_cycle")
  nextBillingDate    DateTime? @map("next_billing_date")
  stripeCustomerId   String?  @unique @map("stripe_customer_id")
  stripeSubscriptionId String? @unique @map("stripe_subscription_id")
  
  organizationType   String?  @map("organization_type") // Startup, Small Business, Mid-Market, Enterprise
  
  // Wallets & Blockchain
  adminWallets       Json     @map("admin_wallets") // Array of {address, role, addedAt, verified}
  treasuryAddresses  Json?    @map("treasury_addresses") // {ethereum, sui, base, polygon, arbitrum, arc}
  treasuryBalance    Json?    @map("treasury_balance") // {ethereum: "0", sui: "0", base: "0", ...}
  ensName            String?  @unique @map("ens_name")
  contractAddresses  Json?    @map("contract_addresses") // {organizationRegistry, privacyPool, stateChannel}
  
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  employees          Employee[]
  authKeys           AuthKey[]
  transactions       Transaction[]
  externalApprovals  ExternalTransactionApproval[]
  payrollRuns        PayrollRun[]
  merkleTree         MerkleTree?
  auditLogs          AuditLog[]

  @@index([kycStatus, createdAt])
  @@index([organizationId])
  @@index([adminEmail])
  @@map("organizations")
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum SubscriptionTier {
  STARTER
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PAYMENT_RECEIVED
  PAID
  FAILED
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

// ============================================================================
// EMPLOYEE MODEL
// ============================================================================

model Employee {
  id                 String   @id @default(cuid())
  employeeId         String   @unique @map("employee_id")
  organizationId     String   @map("organization_id")
  walletAddresses    Json     @map("wallet_addresses") // {ethereum, sui, base, polygon, arbitrum, arc}
  authKeyHash        String   @unique @map("auth_key_hash")
  ensName            String?  @map("ens_name")
  profileData        Json?    @map("profile_data") // {nickname, avatar, email, phoneNumber}
  onboardingDate     DateTime @default(now()) @map("onboarding_date")
  status             EmployeeStatus @default(ACTIVE)
  privacyPreferences Json?    @map("privacy_preferences") // {defaultPrivacyLevel, preferredChain, notificationSettings}
  channels           Json?    // Array of {channelId, network, status, openedAt}
  metadata           Json?    // Additional custom data
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [organizationId], onDelete: Cascade)
  transactionsFrom   Transaction[] @relation("TransactionsFrom")
  transactionsTo     Transaction[] @relation("TransactionsTo")

  @@index([organizationId, status])
  @@index([authKeyHash])
  @@index([employeeId])
  @@map("employees")
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  REVOKED
}

// ============================================================================
// AUTH KEY MODEL
// ============================================================================

model AuthKey {
  id                 String   @id @default(cuid())
  keyHash            String   @unique @map("key_hash")
  organizationId     String   @map("organization_id")
  status             AuthKeyStatus @default(UNUSED)
  assignedEmployeeId String?  @map("assigned_employee_id")
  generatedAt        DateTime @default(now()) @map("generated_at")
  usedAt             DateTime? @map("used_at")
  revokedAt          DateTime? @map("revoked_at")
  expiresAt          DateTime? @map("expires_at")
  metadata           Json?

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [organizationId], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([keyHash])
  @@map("auth_keys")
}

enum AuthKeyStatus {
  UNUSED
  ACTIVE
  REVOKED
  EXPIRED
}

// ============================================================================
// TRANSACTION MODEL
// ============================================================================

model Transaction {
  id                 String   @id @default(cuid())
  transactionId      String   @unique @map("transaction_id")
  organizationId     String   @map("organization_id")
  fromEmployeeId     String   @map("from_employee_id")
  toEmployeeId       String   @map("to_employee_id")
  amount             String   // Using String to avoid precision issues
  currency           String
  chain              String
  transactionType    TransactionType @map("transaction_type")
  blockchainTxHash   String?  @map("blockchain_tx_hash")
  privacyLevel       PrivacyLevel @default(ORGANIZATION_ONLY) @map("privacy_level")
  encryptedDetails   String?  @map("encrypted_details")
  commitmentHash     String?  @map("commitment_hash")
  nullifier          String?
  status             TransactionStatus @default(PENDING)
  timestamp          DateTime @default(now())
  gasUsed            String?  @map("gas_used")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [organizationId], onDelete: Cascade)
  fromEmployee       Employee @relation("TransactionsFrom", fields: [fromEmployeeId], references: [employeeId])
  toEmployee         Employee @relation("TransactionsTo", fields: [toEmployeeId], references: [employeeId])

  @@index([organizationId, timestamp(sort: Desc)])
  @@index([fromEmployeeId, timestamp(sort: Desc)])
  @@index([toEmployeeId, timestamp(sort: Desc)])
  @@index([blockchainTxHash])
  @@index([status])
  @@map("transactions")
}

enum TransactionType {
  YELLOW_OFFCHAIN
  UNISWAP_PRIVACY
  SUI_DIRECT
  CROSS_CHAIN
  PAYROLL
}

enum TransactionStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
  CANCELLED
}

enum PrivacyLevel {
  PUBLIC
  ORGANIZATION_ONLY
  FULLY_PRIVATE
}

// ============================================================================
// MERKLE TREE MODEL
// ============================================================================

model MerkleTree {
  id                 String   @id @default(cuid())
  organizationId     String   @unique @map("organization_id")
  treeRoot           String   @map("tree_root")
  treeHeight         Int      @map("tree_height")
  leaves             Json     // Array of leaf hashes
  lastUpdatedAt      DateTime @default(now()) @map("last_updated_at")
  previousRoots      Json?    @map("previous_roots") // Array of {root, timestamp, employeeCount}

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [organizationId], onDelete: Cascade)

  @@index([organizationId])
  @@map("merkle_trees")
}

// ============================================================================
// STATE CHANNEL MODEL (Optional - for future use)
// ============================================================================

model StateChannel {
  id                 String   @id @default(cuid())
  channelId          String   @unique @map("channel_id")
  employeeId         String   @map("employee_id")
  organizationId     String   @map("organization_id")
  channelState       Json     @map("channel_state") // {balances, nonce, signatures, timeout}
  depositAmount      String   @map("deposit_amount")
  currentBalance     String   @map("current_balance")
  status             ChannelStatus @default(OPENING)
  openedAt           DateTime @default(now()) @map("opened_at")
  lastUpdatedAt      DateTime @updatedAt @map("last_updated_at")
  closedAt           DateTime? @map("closed_at")
  settlementTxHash   String?  @map("settlement_tx_hash")
  metadata           Json?

  @@index([employeeId])
  @@index([organizationId])
  @@index([status])
  @@map("state_channels")
}

enum ChannelStatus {
  OPENING
  OPEN
  SETTLING
  CLOSED
  DISPUTED
}

// ============================================================================
// EXTERNAL TRANSACTION APPROVAL MODEL
// ============================================================================

model ExternalTransactionApproval {
  id                 String   @id @default(cuid())
  approvalId         String   @unique @map("approval_id")
  organizationId     String   @map("organization_id")
  employeeId         String   @map("employee_id")
  toAddress          String   @map("to_address")
  amount             String
  currency           String
  chain              String
  memo               String?
  status             ApprovalStatus @default(PENDING)
  requestedAt        DateTime @default(now()) @map("requested_at")
  reviewedAt         DateTime? @map("reviewed_at")
  reviewedBy         String?  @map("reviewed_by") // Admin wallet address
  rejectionReason    String?  @map("rejection_reason")
  transactionId      String?  @map("transaction_id") // Link to final transaction if approved
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [organizationId], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([employeeId, status])
  @@index([status, requestedAt(sort: Desc)])
  @@map("external_transaction_approvals")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}

// ============================================================================
// PAYROLL RUN MODEL
// ============================================================================

model PayrollRun {
  id                 String   @id @default(cuid())
  payrollId          String   @unique @map("payroll_id")
  organizationId     String   @map("organization_id")
  initiatedBy        String   @map("initiated_by") // Admin wallet address
  totalAmount        String   @map("total_amount")
  currency           String
  chain              String
  employeeCount      Int      @map("employee_count")
  payrollData        Json     @map("payroll_data") // Array of {employeeId, amount, status}
  blockchainTxHash   String?  @map("blockchain_tx_hash")
  status             PayrollStatus @default(PENDING)
  scheduledFor       DateTime? @map("scheduled_for")
  executedAt         DateTime? @map("executed_at")
  gasUsed            String?  @map("gas_used")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [organizationId], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([status])
  @@map("payroll_runs")
}

enum PayrollStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

// ============================================================================
// AUDIT LOG MODEL
// ============================================================================

model AuditLog {
  id                 String   @id @default(cuid())
  logId              String   @unique @map("log_id")
  organizationId     String   @map("organization_id")
  eventType          String   @map("event_type") // external_transaction_approved, payroll_executed, employee_added, etc.
  actorId            String   @map("actor_id") // Wallet address or employee ID
  affectedEntityType String   @map("affected_entity_type") // employee, transaction, organization
  affectedEntityId   String   @map("affected_entity_id")
  encryptedDetails   String?  @map("encrypted_details")
  ipAddress          String?  @map("ip_address")
  userAgent          String?  @map("user_agent")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [organizationId], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([eventType])
  @@index([actorId])
  @@map("audit_logs")
}
